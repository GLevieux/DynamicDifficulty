---
title: "Tank Shooting Game"
output: html_document
---
```{r include = FALSE}
#install.packages("data.table")
#install.packages("ggplot2")

require(data.table)
require(ggplot2)
require(hexbin)
library(knitr)

V2 <- TRUE
removeOutliers  <- TRUE
```

```{r echo=FALSE}
load_data <- function(DTGame, name, sexe, age){
  filename = paste(name, "_log.csv", sep="")
  DT <- as.data.table(read.csv(filename, header = TRUE,sep=";"))
  DT <- head(DT, n=60)
  DT$idPlayer = name
  DT$fail = 1-DT$win
  DT$sexe = sexe
  DT$age = age
  
  DT$variation.Model = 0
  DT$step = 1:nrow(DT)
  
  for( i in 2:nrow(DT)){
    beta0i = DT[i]$beta0;
    beta1i = DT[i]$beta1;
    beta0iprev = DT[i-1]$beta0;
    beta1iprev = DT[i-1]$beta1;
  
    delta = 0;
    for (x in seq(0.1,0.9,0.1))
      delta = delta + (1/(1+exp(-(beta0i+beta1i*x))) - 1/(1+exp(-(beta0iprev+beta1iprev*x))))^2
    DT[i]$variation.Model = sqrt(delta/length(seq(0.1,0.9,0.1)));
  }
  
  if(ncol(DTGame) != 0)
    DT <- merge(DTGame,DT, all=TRUE)
  return(DT)
}


DTGame <- data.table()

if(V2 == TRUE)
{
  DTGame <- load_data(DTGame,"V2/guillaumeV2"    , 1,36)
  DTGame <- load_data(DTGame,"V2/WilliamV2"      , 1,24)
  DTGame <- load_data(DTGame,"V2/thomasV2"       , 1,32)
  DTGame <- load_data(DTGame,"V2/kak@shiV2"      ,-1,31)
  DTGame <- load_data(DTGame,"V2/CronukV2"       ,-1,24)
  DTGame <- load_data(DTGame,"V2/AntoineV2"      , 1,23)
  DTGame <- load_data(DTGame,"V2/Tifanie BV2"    , 0,-1)
  DTGame <- load_data(DTGame,"V2/simon chauvinV2", 1,32)
}else{
  DTGame <- load_data(DTGame,"123456"       ,-1,-1)
  DTGame <- load_data(DTGame,"kak@shi"      ,-1,31)
  DTGame <- load_data(DTGame,"Clement"      , 1,26)
  DTGame <- load_data(DTGame,"Cronuk"       ,-1,24)
  DTGame <- load_data(DTGame,"thomas"       , 1,32)
  DTGame <- load_data(DTGame,"william"      , 1,24)
  DTGame <- load_data(DTGame,"guillaume"    , 1,35) 
  DTGame <- load_data(DTGame,"TB"           , 0,-1)
  DTGame <- load_data(DTGame,"helene"       , 0,36) 
  DTGame <- load_data(DTGame,"olivier"      , 1,-1) 
  DTGame <- load_data(DTGame,"Lauren"       , 0,24)
	DTGame <- load_data(DTGame,"Choucapitch"  , 0,24) 
  DTGame <- load_data(DTGame,"Antoine"      , 1,23) 
  DTGame <- load_data(DTGame,"spotblue"     , 1,25)
  DTGame <- load_data(DTGame,"Indromak"     , 1,29)
  DTGame <- load_data(DTGame,"Roro"         , 0,21)
  DTGame <- load_data(DTGame,"ak"           , 0,-1) 
  DTGame <- load_data(DTGame,"viviane"      , 0,-1) 
  DTGame <- load_data(DTGame,"stephanie"    , 0,-1) 
  DTGame <- load_data(DTGame,"nicole"       , 0,-1) 
  DTGame <- load_data(DTGame,"pierrec"      , 1,45) 
  DTGame <- load_data(DTGame,"pierrep"      , 1,-1) 
  DTGame <- load_data(DTGame,"subhi"        , 1,29) 
  DTGame <- load_data(DTGame,"faten"        , 1,33) 
  DTGame <- load_data(DTGame,"sandra"       , 0,42) 
  DTGame <- load_data(DTGame,"simon chauvin", 1,32) 
  DTGame <- load_data(DTGame,"stephaner"    , 1,35) 
  DTGame <- load_data(DTGame,"Cedric B"     , 1,38) 
	DTGame <- load_data(DTGame,"stan"         , 1,24)
}


plot(DTGame$param.Diff)
plot(DTGame$target.Diff)
plot(x=DTGame$step,y=DTGame$variation.Model)

DTVarModel = DTGame[used.Model==1,.(variation=mean(variation.Model),niveau=mean(param.Diff)), by = idPlayer]

hist(DTVarModel$variation,main = "Histogram of model variability")
hist(DTVarModel$niveau,main = "Histogram of player levels")

boxplot(DTVarModel$niveau,main = "Boxplot of player levels")
boxplot(DTVarModel$variation,main = "Boxplot of player variation")

if(removeOutliers == TRUE)
{
  #remove outliers
  outliers = data.table(id=character(0))
  setkey(outliers,id)
  
  #outliers variation
  outliersVal <- boxplot.stats(DTVarModel$variation)$out
  if(length(outliersVal) > 0)
    outliers = merge(outliers,data.table(id=DTVarModel[variation %in% outliersVal]$idPlayer),by=c("id"),all=TRUE)
  nbOutliersVariation = length(outliersVal)
  
  #outliers niveau
  outliersVal <- boxplot.stats(DTVarModel$niveau)$out
  if(length(outliersVal) > 0)
    outliers = merge(outliers,data.table(id=DTVarModel[niveau %in% outliersVal]$idPlayer),by=c("id"),all=TRUE)
  nbOutliersNiveau = length(outliersVal)
  
  nbTotalOutliers = nrow(outliers)
  
  DTGame[idPlayer %in% unlist(outliers$id)]
}




#plot(DTGame$variation.Model,type="l")

meanFail02 = mean(DTGame[target.Diff < 0.4 & target.Diff > 0.1 & used.Model == 1]$fail)
meanTarget02 = mean(DTGame[target.Diff < 0.4 & target.Diff > 0.1 & used.Model == 1]$target.Diff)
nTarget02 = length(DTGame[target.Diff < 0.4 & target.Diff > 0.1 & used.Model == 1]$target.Diff)
meanParam02 = mean(DTGame[target.Diff < 0.4 & target.Diff > 0.1 & used.Model == 1]$param.Diff)

meanFail05 = mean(DTGame[target.Diff > 0.4 & target.Diff < 0.6 & used.Model == 1]$fail)
meanTarget05 = mean(DTGame[target.Diff > 0.4 & target.Diff < 0.6 & used.Model == 1]$target.Diff)
nTarget05 = length(DTGame[target.Diff > 0.4 & target.Diff < 0.6 & used.Model == 1]$target.Diff)
meanParam05 = mean(DTGame[target.Diff > 0.4 & target.Diff < 0.6 & used.Model == 1]$param.Diff)

meanFail07 = mean(DTGame[target.Diff > 0.6 & used.Model == 1]$fail)
meanTarget07 = mean(DTGame[target.Diff > 0.6 & used.Model == 1]$target.Diff)
nTarget07 = length(DTGame[target.Diff > 0.6 & used.Model == 1]$target.Diff)
meanParam07 = mean(DTGame[target.Diff > 0.6 & used.Model == 1]$param.Diff)

meanStepsConverge = mean(DTGame[used.Model == 0,.N, by = idPlayer]$N)
sdStepsConverge = sd(DTGame[used.Model == 0,.N, by = idPlayer]$N)
nbPlayers = nrow(DTGame[used.Model == 0,.N, by = idPlayer])



scatter.smooth(x=DTVarModel$niveau,y=DTVarModel$variation)
cor(DTVarModel$variation, DTVarModel$niveau)
mdl = glm(DTVarModel$variation ~ DTVarModel$niveau)
summary(mdl)


DStatsPlayer = DTGame[,.(sexe=mean(sexe),age=mean(age)), by = idPlayer]
nbHommes = sum(DStatsPlayer$sexe)
nbFemmes = nrow(DStatsPlayer) - nbHommes
meanAge = mean(DStatsPlayer$age)
sdAge = sd(DStatsPlayer$age)

```


We tested `r nbPlayers` players : `r nbHommes` hommes et `r nbFemmes` femmes avec un age moyen de `r meanAge` (sd=`r sdAge`). On a retire `r nbOutliersVariation` outliers pour la variation du modèle et `r nbOutliersNiveau` outliers pour le niveau pour un total de `r nbTotalOutliers` outliers. For these players, the model took in average `r meanStepsConverge` steps to converge (sd = `r sdStepsConverge`).

Target Diff|Actual Target Diff   | Param           |  p(fail)       |  delta                         | n
-----------|-------------------- | -------------------------------  | ------------------------------ |------
0.2        |   `r meanTarget02`  | `r meanParam02` | `r meanFail02` |  `r meanTarget02-meanFail02`   | `r nTarget02`  
0.5        |   `r meanTarget05`  | `r meanParam05` | `r meanFail05` |  `r meanTarget05-meanFail05`   | `r nTarget05`
0.7        |   `r meanTarget07`  | `r meanParam07` | `r meanFail07` |  `r meanTarget07-meanFail07`   | `r nTarget07`

For each player, we computed the mean variation of model predictions when the model was used : `r kable(DTVarModel[order(niveau)])`


```{r echo=FALSE}

#p = ggplot(data.frame(x=c(0,1)), aes(x)) 
#
#DTTemp = DTGame[idPlayer=="guillaume"];
#for(i in 20:25){
#  beta0 = DTTemp[i]$beta0;
#  beta1 = DTTemp[i]$beta1;
#  print(beta0)
#  p = p + stat_function(fun=function(x)1/(1+exp(-(DTTemp[i]$beta0+DTTemp[i]$beta1*x))), geom="line", aes(colour="square"))
# 
#}


#DTTemp = DTGame[idPlayer=="123456"];
#
#plot(DTTemp$param.Diff)
#
#DTTemp = DTGame[idPlayer=="123456"];
#
#plot(DTTemp$param.Diff)
#
#p = ggplot(data.frame(x=c(0,1)), aes(x)) 

#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[1]$beta0+DTTemp[1]$beta1*x)))), geom="line", aes(alpha = 1/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[2]$beta0+DTTemp[2]$beta1*x)))), geom="line", aes(alpha = 2/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[3]$beta0+DTTemp[3]$beta1*x)))), geom="line", aes(alpha = 3/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[4]$beta0+DTTemp[4]$beta1*x)))), geom="line", aes(alpha = 4/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[5]$beta0+DTTemp[5]$beta1*x)))), geom="line", aes(alpha = 5/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[6]$beta0+DTTemp[6]$beta1*x)))), geom="line", aes(alpha = 6/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[7]$beta0+DTTemp[7]$beta1*x)))), geom="line", aes(alpha = 7/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[8]$beta0+DTTemp[8]$beta1*x)))), geom="line", aes(alpha = 8/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[9]$beta0+DTTemp[9]$beta1*x)))), geom="line", aes(alpha = 9/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[10]$beta0+DTTemp[10]$beta1*x)))), geom="line", aes(alpha = 10/60))

#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[11]$beta0+DTTemp[11]$beta1*x)))), geom="line", aes(alpha = 11/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[12]$beta0+DTTemp[12]$beta1*x)))), geom="line", aes(alpha = 12/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[13]$beta0+DTTemp[13]$beta1*x)))), geom="line", aes(alpha = 13/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[14]$beta0+DTTemp[14]$beta1*x)))), geom="line", aes(alpha = 14/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[15]$beta0+DTTemp[15]$beta1*x)))), geom="line", aes(alpha = 15/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[16]$beta0+DTTemp[16]$beta1*x)))), geom="line", aes(alpha = 16/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[17]$beta0+DTTemp[17]$beta1*x)))), geom="line", aes(alpha = 17/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[18]$beta0+DTTemp[18]$beta1*x)))), geom="line", aes(alpha = 18/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[19]$beta0+DTTemp[19]$beta1*x)))), geom="line", aes(alpha = 19/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[20]$beta0+DTTemp[20]$beta1*x)))), geom="line", aes(alpha = 20/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[21]$beta0+DTTemp[21]$beta1*x)))), geom="line", aes(alpha = 21/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[22]$beta0+DTTemp[22]$beta1*x)))), geom="line", aes(alpha = 22/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[23]$beta0+DTTemp[23]$beta1*x)))), geom="line", aes(alpha = 23/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[24]$beta0+DTTemp[24]$beta1*x)))), geom="line", aes(alpha = 24/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[25]$beta0+DTTemp[25]$beta1*x)))), geom="line", aes(alpha = 25/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[26]$beta0+DTTemp[26]$beta1*x)))), geom="line", aes(alpha = 26/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[27]$beta0+DTTemp[27]$beta1*x)))), geom="line", aes(alpha = 27/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[28]$beta0+DTTemp[28]$beta1*x)))), geom="line", aes(alpha = 28/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[29]$beta0+DTTemp[29]$beta1*x)))), geom="line", aes(alpha = 29/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[30]$beta0+DTTemp[30]$beta1*x)))), geom="line", aes(alpha = 30/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[31]$beta0+DTTemp[31]$beta1*x)))), geom="line", aes(alpha = 31/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[32]$beta0+DTTemp[32]$beta1*x)))), geom="line", aes(alpha = 32/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[33]$beta0+DTTemp[33]$beta1*x)))), geom="line", aes(alpha = 33/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[34]$beta0+DTTemp[34]$beta1*x)))), geom="line", aes(alpha = 34/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[35]$beta0+DTTemp[35]$beta1*x)))), geom="line", aes(alpha = 35/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[36]$beta0+DTTemp[36]$beta1*x)))), geom="line", aes(alpha = 36/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[37]$beta0+DTTemp[37]$beta1*x)))), geom="line", aes(alpha = 37/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[38]$beta0+DTTemp[38]$beta1*x)))), geom="line", aes(alpha = 38/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[39]$beta0+DTTemp[39]$beta1*x)))), geom="line", aes(alpha = 39/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[40]$beta0+DTTemp[40]$beta1*x)))), geom="line", aes(alpha = 40/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[41]$beta0+DTTemp[41]$beta1*x)))), geom="line", aes(alpha = 41/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[42]$beta0+DTTemp[42]$beta1*x)))), geom="line", aes(alpha = 42/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[43]$beta0+DTTemp[43]$beta1*x)))), geom="line", aes(alpha = 43/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[44]$beta0+DTTemp[44]$beta1*x)))), geom="line", aes(alpha = 44/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[45]$beta0+DTTemp[45]$beta1*x)))), geom="line", aes(alpha = 45/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[46]$beta0+DTTemp[46]$beta1*x)))), geom="line", aes(alpha = 46/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[47]$beta0+DTTemp[47]$beta1*x)))), geom="line", aes(alpha = 47/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[48]$beta0+DTTemp[48]$beta1*x)))), geom="line", aes(alpha = 48/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[49]$beta0+DTTemp[49]$beta1*x)))), geom="line", aes(alpha = 49/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[50]$beta0+DTTemp[50]$beta1*x)))), geom="line", aes(alpha = 50/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[51]$beta0+DTTemp[51]$beta1*x)))), geom="line", aes(alpha = 51/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[52]$beta0+DTTemp[52]$beta1*x)))), geom="line", aes(alpha = 52/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[53]$beta0+DTTemp[53]$beta1*x)))), geom="line", aes(alpha = 53/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[54]$beta0+DTTemp[54]$beta1*x)))), geom="line", aes(alpha = 54/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[55]$beta0+DTTemp[55]$beta1*x)))), geom="line", aes(alpha = 55/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[56]$beta0+DTTemp[56]$beta1*x)))), geom="line", aes(alpha = 56/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[57]$beta0+DTTemp[57]$beta1*x)))), geom="line", aes(alpha = 57/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[58]$beta0+DTTemp[58]$beta1*x)))), geom="line", aes(alpha = 58/60))
#p <- p + stat_function(fun=function(x)1-(1/(1+exp(-(DTTemp[59]$beta0+DTTemp[59]$beta1*x)))), geom="line", aes(alpha = 59/60))
#
#  
#print(p)  
#summary(p)

```




